openproject_env_path: "{{openproject_path}}/.rbenv/bin:{{openproject_path}}/.rbenv/shims:{{openproject_path}}/.nodenv/bin:{{openproject_path}}/.nodenv/shims"
unicorn:
  socket: unix
  path: '{{openproject_path}}/unicorn.sock'

_openproject_nginx_vhosts: '{% if openproject_subdirectory == "/" %}{{_openproject_nginx_vhosts_root}}{% else %}{{_openproject_nginx_vhosts_subdir}}{% endif %}'

_openproject_nginx_vhosts_root:
  - name: openproject
    server_names: "{{ openproject_server_names }}"
    root: "{{openproject_path}}/openproject/public"
    try_files: $uri/index.html $uri @openproject
    locations:
      - location: "@openproject"
        proxy_pass: http://unix:{{unicorn.path}}

_openproject_nginx_vhosts_subdir:
  - name: openproject
    server_names: "{{ openproject_server_names }}"
    locations:
      - location: /
        redirect: /{{ openproject_subdirectory }}
      - location: "{{ openproject_subdirectory }}"
        alias: "{{openproject_path}}/openproject/public"
        try_files: $uri/index.html $uri @openproject
      - location: "@openproject"
        proxy_pass: http://unix:{{unicorn.path}}
