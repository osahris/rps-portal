---

- hosts: hosts
  remote_user: root

- hosts: containers
  remote_user: root
  gather_facts: false
  vars:
    lxd_container_source:
      type: image
      mode: pull
      server: https://images.linuxcontainers.org
      protocol: lxd
      alias: "{{ lxd_container_image | default('debian/buster/amd64') }}"
    lxd_container_config:
      limits.cpu: "{{ lxd_container_limits_cpu | default(2) | string}}"
      limits.memory: "{{ lxd_container_limits_memory | default('2GB') | string }}"
      security.nesting: "{{ lxd_container_security_nesting | default(false) | string }}"
  tasks:

    - name: lxd container installed and started
      community.general.lxd_container:
        name: "{{inventory_hostname}}"
        state: started
        source: "{{lxd_container_source}}"
        config: "{{lxd_container_config}}"
        profiles: ["default"]
        wait_for_ipv4_addresses: true
        timeout: 600
      delegate_to: "{{ lxd_host }}"

    - name: make sure host_vars directory is present for host
      local_action: file
      args:
        path: "{{inventory_dir}}/host_vars/{{inventory_hostname}}"
        state: directory

    - name: record variables for lxd container connection in host_vars
      local_action: copy
      args:
        content:
          ansible_connection: lxc_ssh
          ansible_host: "{{hostvars[lxd_host].ansible_host}}"
          ansible_ssh_extra_args: "{{inventory_hostname}}"
        dest: "{{inventory_dir}}/host_vars/{{inventory_hostname}}/lxd_host.auto.json"

    - name: refresh ansible inventory
      local_action: meta refresh_inventory

- hosts: containers
  remote_user: root
