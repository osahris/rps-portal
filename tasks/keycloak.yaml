---

- import_role:
    name: docker

- name: create traefik dir
  file:
    path: /var/lib/traefik
    state: directory

- name: install git # we need to fetch the theme
  apt:
    name: git
    state: present

- name: traefik config
  template:
    src: "traefik.toml.j2"
    dest: /var/lib/traefik/traefik.toml
  register: traefik_conf

- name: create ingress network
  community.general.docker_network:
    name: ingress

- name: install traefik
  community.general.docker_container:
    name: traefik
    image: traefik:v2.3
    restart_policy: always
    ports:
      - 80:80
      - 443:443
      - 127.0.0.1:8080:8080 # dashboard. should not be publically visible. use ssh tunnel to view it
    networks:
      - name: ingress
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/traefik/traefik.toml:/etc/traefik/traefik.toml
      - /var/lib/traefik/certs:/var/traefik_certs
    restart: "{{ traefik_conf.changed }}"

- name: create keycloak network
  community.general.docker_network:
    name: keycloak

# hmm deploy via docker or standalone? docker way for now
- name: postgres
  community.general.docker_container:
    name: keycloak-postgres
    image: postgres:12.4 # postgres 13 is just out. use more stable version
    restart_policy: always
    networks:
      - name: keycloak
    volumes:
      - /var/lib/postgres/:/var/lib/postgresql/data # maybe use docker volume instead host volume?
    env:
      POSTGRES_USER: keycloak
      POSTGRES_DB: keycloak # explicitly (default == POSTGRES_USER)
      POSTGRES_PASSWORD: "{{ keycloak_postgres_password }}"

- block:
    - name: fetch keycloak theme
      git:
        repo: "{{ keycloak_theme }}"
        dest: "/var/lib/keycloak/themes/ansible-theme"
        version: master
      register: theme

    - name: set themes
      set_fact:
        keycloak_realm: "{{ keycloak_realm | combine({'loginTheme': 'ansible-theme', 'accountTheme': 'ansible-theme'}) }}"

    - name: keycloak script directory
      file:
        path: /var/lib/keycloak/scripts
        state: directory

    - name: copy disable theme cache script
      copy:
        src: disable-theme-cache.cli
        dest: /var/lib/keycloak/scripts/disable-theme-cache.cli

    - name: keycloak volumes
      set_fact:
        keycloak_volumes:
          - "/var/lib/keycloak/themes/ansible-theme:/opt/jboss/keycloak/themes/ansible-theme"
          - "/var/lib/keycloak/scripts/disable-theme-cache.cli:/opt/jboss/startup-scripts/disable-theme-cache.cli"
  when: keycloak_theme is defined

- name: keycloak docker deployment
  community.general.docker_container:
    name: keycloak
    image: jboss/keycloak:11.0.2
    restart_policy: always
    state: started
    networks:
      - name: ingress
      - name: keycloak
    volumes: "{{ keycloak_volumes | default([]) }}"
    restart: "{{ theme.changed }}"
    env:
      DB_VENDOR: postgres
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: "{{ keycloak_admin_password }}"
      KEYCLOAK_FRONTEND_URL: "{{ keycloak_frontend_url }}"
      # KEYCLOAK_LOGLEVEL: TRACE
      PROXY_ADDRESS_FORWARDING: "true"
      DB_ADDR: keycloak-postgres
      DB_DATABASE: keycloak # also default but specify explicitly
      DB_USER: keycloak
      DB_PASSWORD: "{{ keycloak_postgres_password }}"
    labels:
      traefik.enable: "true"
      traefik.http.routers.keycloak-https.rule: Host(`{{ inventory_hostname }}`)
      traefik.http.routers.keycloak-https.entrypoints: https
      traefik.http.routers.keycloak-https.tls.certresolver: letsencrypt
      traefik.http.routers.keycloak-http.rule: Host(`{{ inventory_hostname }}`)
      traefik.http.routers.keycloak-http.entrypoints: http

- name: Wait for keycloak
  uri:
    url: "{{ keycloak_frontend_url }}"
    status_code: 200
  register: result
  until: result.status == 200
  retries: 180
  delay: 1

- name: "Create Token for service Keycloak"
  uri:
    url: "{{ keycloak_frontend_url }}/realms/master/protocol/openid-connect/token"
    method: POST
    body_format: form-urlencoded
    body:
      username: "admin"
      password: "{{ keycloak_admin_password }}"
      grant_type: "password"
      client_id: "admin-cli"
  register: keycloak_token

- name: "Find out, if Realm {{ keycloak_realm_name }} for service Keycloak exists"
  uri:
    url: "{{ keycloak_frontend_url }}/admin/realms/{{ keycloak_realm_name }}"
    method: GET
    status_code:
     - 200
     - 404
    headers:
      Accept: "application/json"
      Authorization: "Bearer {{ keycloak_token.json.access_token }}"
  register: keycloak_realm_exists

- name: "Create Realm {{ keycloak_realm_name }} for service Keycloak"
  uri:
    url: "{{ keycloak_frontend_url }}/admin/realms"
    method: POST
    body: "{{ keycloak_realm }}"
    body_format: "json"
    remote_src: "no"
    status_code:
     - 201
    headers:
      Content-type: "application/json"
      Accept: "application/json"
      Authorization: "Bearer {{ keycloak_token.json.access_token }}"
  register: keycloak_realm_create
  when: "keycloak_realm_exists.status == 404"

- name: "Update Realm {{ keycloak_realm_name }} for service Keycloak"
  uri:
    url: "{{ keycloak_frontend_url }}/admin/realms/{{ keycloak_realm_name }}"
    method: PUT
    body: "{{ keycloak_realm }}"
    body_format: "json"
    remote_src: "no"
    status_code:
     - 204
    headers:
      Content-type: "application/json"
      Accept: "application/json"
      Authorization: "Bearer {{ keycloak_token.json.access_token }}"
  register: keycloak_realm_create
  when: "keycloak_realm_exists.status == 200"
