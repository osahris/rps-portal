---
- name: require pipenv
  apt:
    pkg:
      - pipenv

- name: create sync jobs bin dir
  file:
    path: /opt/sync-scripts/bin
    state: directory

- name: create sync jobs lib dir
  file:
    path: /opt/sync-scripts/lib
    state: directory

- name: fetch user-management-scripts
  git:
    repo: "https://{{ gitlab_deploy_token }}@gitlab.com/research-project-suite/user-management-scripts.git"
    dest: /opt/sync-scripts/lib/user-management-scripts

- name: install user-management-scripts deps
  shell: pipenv install --deploy
  args:
    chdir: /opt/sync-scripts/lib/user-management-scripts

- name: copy sync-scripts script
  template:
    src: sync-scripts.sh.j2
    dest: /opt/sync-scripts/bin/sync-scripts.sh
    owner: root
    group: root
    mode: '0755'

- name: install sync-scripts systemd unit
  copy:
    src: sync-scripts.service
    dest: /etc/systemd/system/sync-scripts.service
  notify:
    - reload systemd

- name: install sync-scripts systemd timer
  copy:
    src: sync-scripts.timer
    dest: /etc/systemd/system/sync-scripts.timer
  notify:
    - reload systemd

- name: flush handlers
  meta: flush_handlers

- name: ensure sync-scripts systemd timer is enabled and started
  systemd:
    name: sync-scripts.timer
    state: started
    enabled: yes
