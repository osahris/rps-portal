---

- import_role:
    name: docker

- name: debian requirements
  apt:
    pkg:
      - git

- name: discourse docker repo
  git:
    repo: https://github.com/discourse/discourse_docker.git
    dest: /var/lib/discourse

- name: discourse container config
  template:
    src: "{{item}}.yaml.j2"
    dest: /var/lib/discourse/containers/{{item}}.yml
  with_items: "{{ discourse_containers }}"
  register: changed_config

- name: rebuild discourse containers
  command: ./launcher rebuild "{{item[0]}}"
  args:
    chdir: /var/lib/discourse
  loop: "{{ discourse_containers | zip(changed_config.results) | list }}"
  # only rebuild if config changed
  when: item[1].changed

- name: ensure all started
  command: ./launcher start "{{item}}"
  args:
    chdir: /var/lib/discourse
  loop: "{{ discourse_containers }}"

- name: ensure discourse client
  local_action:
    module: keycloak_client
    auth_client_id: admin-cli
    auth_keycloak_url: "{{ discourse_keycloak_frontend_url }}"
    auth_realm: master
    auth_username: "{{ discourse_keycloak_management_username }}"
    auth_password: "{{ discourse_keycloak_management_password }}"
    client_id: discourse
    realm: "{{ discourse_keycloak_realm_name }}"
    redirect_uris: [
      "{{ discourse_keycloak_redirect_uri }}"
    ]
    client_authenticator_type: client-secret
    secret: "{{ discourse_openid_client_secret }}"
    state: present

- name: enable tls for mail-receiver # TODO integrate in mail-receiver.yaml
  shell: |
    docker container exec mail-receiver bash -c "echo 'smtps     inet  n       -       n       -       -       smtpd'  >> /etc/postfix/master.cf"
    docker container exec mail-receiver bash -c "echo '  -o syslog_name=postfix/smtps' >> /etc/postfix/master.cf"
    docker container exec mail-receiver bash -c "echo '  -o smtpd_tls_wrappermode=yes' >> /etc/postfix/master.cf"
    docker container restart mail-receiver
  when: discourse_mail_reveiver_tls_enabled
