---
- name: "Create access_token for keycloak for user {{ keycloak_admin_username }}"
  local_action: uri
  args:
    url: "{{ keycloak_frontend_url }}/realms/master/protocol/openid-connect/token"
    method: POST
    validate_certs: "{{ keycloak_validate_certs }}"
    body_format: form-urlencoded
    body:
      username: "{{ keycloak_admin_username }}"
      password: "{{ keycloak_admin_password | mandatory }}"
      grant_type: "password"
      client_id: "admin-cli"
  register: keycloak_token
- name: "create group authentication flow for {{ item.name }} in {{ keycloak_mainrealm.name }}"
  community.general.keycloak_authentication:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ keycloak_mainrealm.name }}"
    alias: "{{ item.name }}-browser-flow"
    copyFrom: "browser"
    authenticationExecutions: []
    state: present
  register: authentication_flow
- name: "handle require-group authentication execution for {{ item.name }} in {{ keycloak_mainrealm.name }}"
  keycloak_required_groups_from_mainrealm_flow:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ keycloak_mainrealm.name }}"
    flow: "{{ item.name }}-browser-flow"
    subflow: "{{ item.name }}-browser-flow forms"
    required_groups_from_mainrealm: "{{ item.required_groups_from_mainrealm|default([]) }}"
- name: "create subrealm {{ item.name }}"
  community.general.keycloak_realm:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    id: "{{ item.name }}"
    realm: "{{ item.name }}"
    enabled: true
    state: present
- name: "subrealm {{ item.name }} should have groups"
  community.general.keycloak_group:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ item.name }}"
    name: "{{ group }}"
    attributes:
      managed: "true"
    state: present
  loop: "{{ item.groups|default([]) }}"
  loop_control:
    loop_var: group
- name: "subrealm {{ item.name }} should have roles"
  community.general.keycloak_role:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ item.name }}"
    name: "{{ role }}"
    attributes:
      managed: "true"
    state: present
  loop: "{{ item.roles|default([]) }}"
  loop_control:
    loop_var: role
- name: "create client for {{ item.name }} in mainrealm"
  community.general.keycloak_client:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ keycloak_mainrealm.name }}"
    client_id: "{{ item.name }}-idp"
    secret: "{{ item.client_secret }}"
    client_authenticator_type: client-secret
    redirect_uris:
      - "{{ keycloak_frontend_url }}/realms/{{ item.name }}/broker/{{ keycloak_mainrealm.name }}-idp/endpoint"
    protocol_mappers: "{{ item.import|default([])|to_client_mappers }}"
    authentication_flow_binding_overrides:
      browser: "{{ authentication_flow.end_state.id }}"
    state: present
  register: client
- name: "create post login flow for {{ item.name }}"
  community.general.keycloak_authentication:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ item.name }}"
    alias: "post-idp-login"
    providerId: "basic-flow"
    authenticationExecutions:
      - providerId: "require-role-membership"
        requirement: "REQUIRED"
        authenticationConfig:
          alias: "role-membership-check"
          config:
            roles: '{{ item.required_roles | default([]) | join(",") }}'
- name: "create idp for {{ item.name }}"
  community.general.keycloak_identity_provider:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ item.name }}"
    alias: "users-idp"
    display_name: "users idp"
    enabled: true
    provider_id: "oidc"
    trust_email: true
    postBrokerLoginFlowAlias: "post-idp-login"
    mappers: "{{ item.import|default([])|to_idp_mappers }}"
    config:
      issuer: "{{ keycloak_frontend_url }}/realms/{{ keycloak_mainrealm.name }}"
      authorizationUrl: "{{ keycloak_frontend_url }}/realms/{{ keycloak_mainrealm.name }}/protocol/openid-connect/auth"
      tokenUrl: "{{ keycloak_frontend_url }}/realms/{{ keycloak_mainrealm.name }}/protocol/openid-connect/token"
      userInfoUrl: "{{ keycloak_frontend_url }}/realms/{{ keycloak_mainrealm.name }}/protocol/openid-connect/userinfo"
      clientAuthMethod: client_secret_post
      clientId: "{{ item.name }}-idp"
      clientSecret: "{{ item.client_secret }}"
      syncMode: FORCE
    state: present
- name: "create immediate redirect authentication flow for {{ item.name }}"
  community.general.keycloak_authentication:
    auth_keycloak_url: "{{ keycloak_frontend_url }}"
    token: "{{ keycloak_token.json.access_token }}"
    realm: "{{ item.name }}"
    alias: "idp-redirect"
    providerId: "basic-flow"
    authenticationExecutions:
      - providerId: "identity-provider-redirector"
        requirement: "REQUIRED"
        authenticationConfig:
          alias: "idp"
          config:
            defaultProvider: "users-idp"
    state: present
- name: "Set browser flow to idp redirect"
  local_action: uri
  args:
    url: "{{ keycloak_frontend_url }}/admin/realms/{{ item.name }}"
    method: PUT
    validate_certs: "{{ keycloak_validate_certs }}"
    body: '{"browserFlow": "idp-redirect"}'
    body_format: "json"
    remote_src: "no"
    status_code:
      - 204
    headers:
      Content-type: "application/json"
      Accept: "application/json"
      Authorization: "Bearer {{ keycloak_token.json.access_token }}"
