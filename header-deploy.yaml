---

- hosts: localhost
  vars:
    header_config_json_content:
      keycloakUrl: "{{ header_keycloak_auth_url }}"
      keycloakRealm: users
      keycloakClientId: header
      logoUri: "{{ header_logo_uri }}"
      keycloakLogoutRedirectUri: "{{ header_keycloak_logout_redirect_uri }}"
      cookieDomain: "{{ header_cookie_domain }}"
      links: "{{ header_links }}"
      contactUrl: "{{ header_contact_url }}"

  tasks:
    - name: clone header repo
      git:
        repo: https://{{gitlab_deploy_token}}@gitlab.com/research-project-suite/header.git
        dest: header
        version: "{{ header_version | default('master') }}"
    - name: write header config
      copy:
        content: "{{ header_config_json_content | to_json}}"
        dest: header/config.json
    - name: select theme
      file:
        src: "themes/{{header_theme}}"
        dest: header/theme
        state: link
        force: yes
    - name: satisfy headers npm requirements
      npm:
        path: header
    - name: compile header
      command: ./node_modules/rollup/dist/bin/rollup --config
      args:
        chdir: header

- hosts: keycloak_servers
  remote_user: root
  tasks:
    - name: deploy theme header to keycloak account theme
      copy:
        src: header/header.js
        dest: /var/lib/keycloak/themes/ansible-theme/account/resources/js/
    - name: deploy theme header to keycloak login theme
      copy:
        src: header/header.js
        dest: /var/lib/keycloak/themes/ansible-theme/login/resources/js/

- hosts: wordpress_servers
  remote_user: root
  tasks:
    - name: deploy header to websites
      copy:
        src: header/header.js
        dest: /var/www/{{wordpress_instance_name}}/

- hosts: discourse_servers
  remote_user: root
  tasks:
    - name: deploy header to discourse
      copy:
        src: header/header.js
        dest: ~/header.js
    - name: copy header into discourse docker container
      command: docker cp ~/header.js web:/var/www/discourse/public

- hosts: nextcloud_servers
  remote_user: root
  tasks:
    - name: deploy header to nextcloud
      copy:
        src: header/header.js
        dest: /var/www/nextcloud/
