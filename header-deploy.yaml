---

- hosts: localhost
  tasks:
    - name: clone header repo
      git:
        repo: https://{{gitlab_deploy_token}}@gitlab.com/research-project-suite/header.git
        dest: header
        version: auth
        version: "{{ header_version }}"
    - name: write header config
      copy:
        content: "{{ header_config | to_json}}"
        dest: header/config.json
    - name: select theme
      file:
        src: "themes/{{header_theme}}"
        dest: header/theme
        state: link
        force: yes
    - name: satisfy headers npm requirements
      npm:
        path: header
    - name: compile header
      command: ./node_modules/rollup/dist/bin/rollup --config
      args:
        chdir: header

- hosts: reverse_proxies
  remote_user: root
  tasks:
    - name: deploy header to reverse proxies
      copy:
        src: header/header.js
        dest: /var/www/header.js

- hosts: keycloak_servers
  remote_user: root
  tasks:
    - name: deploy theme header to keycloak account theme
      copy:
        src: header/header.js
        dest: /var/lib/keycloak/themes/ansible-theme/account/resources/js/
    - name: deploy theme header to keycloak login theme
      copy:
        src: header/header.js
        dest: /var/lib/keycloak/themes/ansible-theme/login/resources/js/
