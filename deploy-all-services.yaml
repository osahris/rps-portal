---
- hosts: rps_servers
  become: true

  pre_tasks:
    - block:
        - name: Display current host
          debug:
            msg:
              - "{{ ansible_ssh_host }}"
              - "{{ inventory_hostname }}"
        - name: Create ansible facts directory
          file:
            path: /etc/ansible/facts.d
            state: directory
        - name: Copy ansible secrets facts
          copy:
            content: "{{ secrets_fact | to_nice_json }}"
            dest: /etc/ansible/facts.d/secrets.fact
        - name: Gather facts again after secrets generation
          setup:
      tags:
        - always

  roles:
    - role: docker
      tags: docker
    - role: gitlab_credentials
      tags: gitlab_credentials
    - role: traefik
      tags: traefik
    - role: collabora
      tags: collabora
    - role: idia
      tags: idia
    - role: keycloak
      tags: keycloak
    - role: keycloak-realms
      tags: keycloak-realms
    - role: oauth2-proxy
      tags: oauth2-proxy
    - role: rps-groups-interface
      tags: rps-groups-interface
    - role: rps_admin_interface
      tags: rps_admin_interface
    - role: header
      tags: header
    - role: static_header_test
      tags: static_header_test
