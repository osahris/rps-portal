---
- hosts: rps_servers
  become: true

  pre_tasks:
    - block:
        - name: Display current host
          debug:
            msg:
              - "{{ ansible_ssh_host }}"
              - "{{ inventory_hostname }}"
        - name: Create ansible facts directory
          file:
            path: /etc/ansible/facts.d
            state: directory
        - name: Copy ansible secrets facts
          copy:
            content: "{{ secrets_fact | to_nice_json }}"
            dest: /etc/ansible/facts.d/secrets.fact
        - name: Gather facts again after secrets generation
          setup:
      tags:
        - always

  roles:
    - role: docker
      tags: docker, core
    - role: gitlab_credentials
      tags: gitlab_credentials, gitlab-credentials, core
    - role: traefik
      tags: traefik, core
    - role: idia
      tags: idia, core
    - role: keycloak
      tags: keycloak, core
    - role: keycloak_realms
      tags: keycloak_realms, keycloak-realms, core
    - role: oauth2_proxy
      tags: oauth2_proxy, core
    - role: rps_groups_interface
      tags: rps_groups_interface, rps-groups-interface
    - role: rps_admin_interface
      tags: rps_admin_interface, rps-admin-interface
    - role: rps_header
      tags: rps_header, rps-header
    - role: static_header_test
      tags: static_header_test, static-header-test, core
    - role: wordpress
      tags: wordpress
    - role: nextcloud
      tags: nextcloud
    # - role: typesense
    #   tags: typesense
    - role: collabora
      tags: collabora
    - role: wiki-js
      tags: wiki_js, wiki-js
    - role: rocketchat
      tags: rocketchat
    # - role: wiki-bookstack
    #   tags: wiki_bookstack, wiki-bookstack
    - role: matchmaking
      tags: matchmaking
    - role: minimum_viable_product
      tags: minimum_viable_product, minimum-viable-product