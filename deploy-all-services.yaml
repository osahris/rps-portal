---
- hosts: rps_servers
  become: true

  pre_tasks:
    - block:
        - name: Display current host
          debug:
            msg:
              - "{{ ansible_ssh_host }}"
              - "{{ inventory_hostname }}"
        - name: Create ansible facts directory
          file:
            path: /etc/ansible/facts.d
            state: directory
        - name: Copy ansible secrets facts
          copy:
            content: "{{ secrets_fact | to_nice_json }}"
            dest: /etc/ansible/facts.d/secrets.fact
        - name: Gather facts again after secrets generation
          setup:
      tags:
        - always

  roles:
    - role: docker
      tags: docker
    - role: gitlab_credentials
      tags: gitlab_credentials
    - role: traefik
      tags: traefik
    - role: keycloak
      tags: keycloak
    - role: keycloak_realms
      tags: keycloak_realms
    - role: oauth2_proxy
      tags: oauth2_proxy
    - role: idia
      tags: idia
    - role: rps_groups_interface
      tags: rps_groups_interface
    - role: rps_admin_interface
      tags: rps_admin_interface
    - role: rps_header
      tags: rps_header
    - role: static_header_test
      tags: static_header_test
    - role: wordpress
      tags: wordpress
    - role: nextcloud
      tags: nextcloud
    - role: collabora
      tags: collabora
    - role: wiki-js
      tags: wiki-js
    - role: discourse
      tags: discourse
    # - role: wiki-js
    #   tags: wiki-js
    # - role: wiki-bookstack
    #   tags: wiki-bookstack
    - role: matchmaking
      tags: matchmaking