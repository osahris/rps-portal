reverse_proxy_server_name: "{{nextcloud_server_name}}"
# X-Forwarded-Proto header is needed for nextcloud oidc app scheme auto-detection
reverse_proxy_nginx_vhost_custom: |
  location / {
    proxy_set_header X-Forwarded-Proto https;
    proxy_pass http://{{inventory_hostname}}:80/;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    client_max_body_size 1G;
  }
  location ^~ /.well-known {
    # The following 6 rules are borrowed from `.htaccess`

    rewrite ^/\.well-known/host-meta\.json  /public.php?service=host-meta-json  last;
    rewrite ^/\.well-known/host-meta        /public.php?service=host-meta       last;
    rewrite ^/\.well-known/webfinger        /public.php?service=webfinger       last;
    rewrite ^/\.well-known/nodeinfo         /public.php?service=nodeinfo        last;

    location = /.well-known/carddav     { return 301 /remote.php/dav/; }
    location = /.well-known/caldav      { return 301 /remote.php/dav/; }

    try_files $uri $uri/ =404;
  }
  {{header_nginx_inclusion}}
