---

- import_role:
    name: podman

- import_role:
    name: nodejs

- name: required debian packages
  apt:
    pkg:
      - git

- name: Clone header repo
  git:
    repo: "{{ header_repo }}"
    dest: /opt/header
    version: "{{ header_version }}"
    force: yes

- name: Clone header config repo
  git:
    repo: "{{ header_config_repo }}"
    dest: /opt/header_config
    version: "{{ header_config_version }}"

- name: List files in /opt/header_config/files
  find:
    path: /opt/header_config/files/
    recurse: yes
    file_type: any
  register: find_result

- name: Create the directories
  file:
    path: "{{ item.path | regex_replace('/opt/header_config/files','/opt/header') }}"
    state: directory
    # mode: "{{ item.mode }}"
  with_items:
    - "{{ find_result.files }}"
  when:
    - item.isdir

- name: Copy the files
  copy:
    src: "{{ item.path }}"
    dest: "{{ item.path | regex_replace('/opt/header_config/files','/opt/header') }}"
    remote_src: yes
    # mode: "{{ item.mode }}"
  with_items:
    - "{{ find_result.files }}"
  when:
    - item.isdir == False


- name: Install packages based on package.json using the npm
  npm:
    path: /opt/header/
    state: present

- name: Build app
  command: npm run build
  args:
    chdir: /opt/header/

- name: Build header image
  containers.podman.podman_image:
    name: header
    path: /opt/header
    tag: current
    force: true
    build:
      rm: false

- name: Start header container
  containers.podman.podman_container:
    name: header
    image: header:current
    ports:
     - "80:80"
    recreate: true
  