---

- name: discourse app discourse_target_directory
  file:
    path: "{{discourse_target_directory}}"
    state: directory

- name: postgres env file
  template:
    src: "postgres.env.j2"
    dest: "{{discourse_target_directory}}/postgres.env"

- name: discourse docker repo
  git:
    repo: https://github.com/discourse/discourse_docker.git
    dest: "{{discourse_target_directory}}/discourse_docker"

- name: discourse web image builder config
  template:
    src: "web.yaml.j2"
    dest: "{{discourse_target_directory}}/discourse_docker/containers/{{discourse_service_name|replace('.', '')}}_web_image_builder.yml"
  register: discourse_web_image_builder_task

- when: discourse_web_image_builder_task.changed
  block:
  - name: docker-compose file for databases
    template:
      src: "docker-compose.yaml.j2"
      dest: "{{discourse_target_directory}}/docker-compose.yaml"
      force: yes
    vars:
      discourse_with_web_in_docker_compose: false

  - name: deploy docker-compose stack without databases
    docker_compose:
      project_src: "{{discourse_target_directory}}/"

  - name: bootstrap discourse web container
    command: ./launcher bootstrap {{discourse_service_name|replace('.', '')}}_web_image_builder
    args:
      chdir: "{{discourse_target_directory}}/discourse_docker"

- name: discourse web env file
  template:
    src: "web.env.j2"
    dest: "{{discourse_target_directory}}/web.env"

# - name: bootstrap discourse mail-receiver container
#   command: ./launcher bootstrap {{discourse_service_name|replace('.', '')}}_mail_receiver_1
#   args:
#     chdir: "{{discourse_target_directory}}/discourse_docker"
#   when: 
#     - discourse_mail_reveiver_enabled
#     - discourse_mail_receiver_container_task.changed

# - name: discourse mail-receiver container config
#   template:
#     src: "mail-receiver.yaml.j2"
#     dest: "{{discourse_target_directory}}/discourse_docker/containers/{{discourse_service_name|replace('.', '')}}_mail_receiver_1.yml"
#   register: discourse_mail_receiver_container_task
#   when: discourse_mail_reveiver_enabled

# - when: discourse_web_image_builder_task.changed and discourse_mail_reveiver_enabled

- name: docker-compose file
  template:
    src: "docker-compose.yaml.j2"
    dest: "{{discourse_target_directory}}/docker-compose.yaml"

- name: deploy docker-compose stack
  docker_compose:
    project_src: "{{discourse_target_directory}}/"

- name: traefik dynamic config
  copy:
    content: "{{ discourse_traefik_dynamic_config }}"
    dest: "/app/proxy/traefik/conf.d/{{discourse_service_name}}.yaml"

- name: ensure discourse keycloak client
  local_action:
    module: keycloak_client
    auth_client_id: admin-cli
    auth_keycloak_url: "{{ discourse_keycloak_frontend_url }}"
    auth_realm: "{{ discourse_keycloak_management_realm }}"
    auth_username: "{{ discourse_keycloak_management_username }}"
    auth_password: "{{ discourse_keycloak_management_password }}"
    client_id: discourse
    realm: "{{ discourse_keycloak_realm_name }}"
    redirect_uris:
      - "{{ discourse_keycloak_redirect_uri }}"
    validate_certs: "{{ discourse_validate_certs }}"
    client_authenticator_type: client-secret
    secret: "{{ discourse_openid_client_secret }}"
    state: present
