---
- name: discourse docker network
  docker_network:
    name: "{{discourse_service_name|replace('.', '')}}"

- name: discourse docker repo
  git:
    repo: https://github.com/discourse/discourse_docker.git
    dest: "{{discourse_target_directory}}"

- name: discourse postgres container config
  template:
    src: "postgres.yaml.j2"
    dest: "{{discourse_target_directory}}/containers/{{discourse_service_name|replace('.', '')}}_postgres_1.yml"
  register: discourse_postgres_container_task

- name: discourse redis container config
  template:
    src: "redis.yaml.j2"
    dest: "{{discourse_target_directory}}/containers/{{discourse_service_name|replace('.', '')}}_redis_1.yml"
  register: discourse_redis_container_task

- name: discourse web container config
  template:
    src: "web.yaml.j2"
    dest: "{{discourse_target_directory}}/containers/{{discourse_service_name|replace('.', '')}}_web_1.yml"
  register: discourse_web_container_task

- name: discourse mail-receiver container config
  template:
    src: "mail-receiver.yaml.j2"
    dest: "{{discourse_target_directory}}/containers/{{discourse_service_name|replace('.', '')}}_mail_receiver_1.yml"
  register: discourse_mail_receiver_container_task
  when: discourse_mail_reveiver_enabled

- name: rebuild discourse postgres container
  command: ./launcher rebuild {{discourse_service_name|replace('.', '')}}_postgres_1 --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"
  when: discourse_postgres_container_task.changed

- name: rebuild discourse redis container
  command: ./launcher rebuild {{discourse_service_name|replace('.', '')}}_redis_1 --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"
  when: discourse_redis_container_task.changed

- name: rebuild discourse web container
  command: ./launcher rebuild {{discourse_service_name|replace('.', '')}}_web_1 --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"
  when: discourse_web_container_task.changed

- name: rebuild discourse mail-receiver container
  command: ./launcher rebuild {{discourse_service_name|replace('.', '')}}_mail_receiver_1 --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"
  when: 
    - discourse_mail_reveiver_enabled
    - discourse_mail_receiver_container_task.changed

- name: ensure web container is connected to proxy network
  docker_network:
    name: proxy
    connected:
      - "{{discourse_service_name|replace('.', '')}}_web_1"

- name: ensure postgres container is started
  command: ./launcher start postgres --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"

- name: ensure redis container is started
  command: ./launcher start redis --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"

- name: ensure web container is started
  command: ./launcher start web --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"

- name: ensure mail-receiver container is started
  command: ./launcher start mail-receiver --skip-prereqs
  args:
    chdir: "{{discourse_target_directory}}"
  when: discourse_mail_reveiver_enabled

- name: ensure discourse keycloak client
  local_action:
    module: keycloak_client
    auth_client_id: admin-cli
    auth_keycloak_url: "{{ discourse_keycloak_frontend_url }}"
    auth_realm: "{{ discourse_keycloak_management_realm }}"
    auth_username: "{{ discourse_keycloak_management_username }}"
    auth_password: "{{ discourse_keycloak_management_password }}"
    client_id: discourse
    realm: "{{ discourse_keycloak_realm_name }}"
    redirect_uris: [
      "{{ discourse_keycloak_redirect_uri }}"
    ]
    validate_certs: "{{ discourse_validate_certs }}"
    client_authenticator_type: client-secret
    secret: "{{ discourse_openid_client_secret }}"
    state: present
