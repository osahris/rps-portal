- name: Intialize htpasswds variable
  set_fact:
    htpasswds: ""

- name: Loop over backup client htpasswds
  loop: "{{ groups['backup_clients'] }}"
  # TODO: differentiate between multiple passwords when a client connects multiple servers
  set_fact:
    htpasswds: "{{hostvars[item].ansible_facts.ansible_local.backupuser_htpasswds.backupuser_htpasswds.pw1}}\n{{htpasswds}}"

- name: Debug output of generated .htpasswd file
  # XXX delme
  ansible.builtin.debug:
    var: htpasswds

- name: Set contents of .htpasswd file
  ansible.builtin.copy:
    dest: "{{ restic_rest_backupstorage | default('/srv/backupstorage/') }}/.htpasswd"
    owner: root
    group: restic-service
    mode: '0640'
    follow: no
    content: "{{htpasswds}}"
  when: htpasswds is defined and htpasswds!=''

- name: Have Systemd (re)start the restic-rest daemon
  ansible.builtin.systemd:
    daemon_reload: yes
    name: restic-server.service
    state: restarted

