---
#- import_tasks: local_facts.yaml

- name: ensure restic is installed from distribution repositories
  apt:
        name:
          - restic
          - pwgen
        state: present

- name: create /etc/restic directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/restic
    - /etc/restic/config

- name: create /etc/restic directories (II)
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0700'
  loop:
    - /etc/restic/repositories
    - /etc/restic/passwords

- name: Create directory for ansible custom facts
  ansible.builtin.file:
    state: directory
    recurse: yes
    mode: 0700
    path: /etc/ansible/facts.d

- name: Create the restic per-backup config files
  template:
    src: 'per_backup.env.j2'
    dest: '/etc/restic/config/{{ item.name }}.env'
  loop: "{{ restic_backup_directives }}"
  when: item.content is undefined
  # The Systemd service unit will read these via EnvironmentFile=

- name: (Re-)create the restic config files (for special cases)
  ansible.builtin.copy:
    dest: '/etc/restic/config/{{ item.name }}.env'
    content: "{{ item.content }}"
  loop: "{{ restic_backup_directives }}"
  when: item.content is defined
  # or these, depending on the configuration

- name: Write out restic per-repos secrets
  ansible.builtin.copy:
    dest: '/etc/restic/repositories/{{ item.repository }}.key'
    content: "{{ item.key }}"
  loop: "{{ restic_backup_directives }}"

#- name: Check repository initialization and status
#  ansible.builtin.shell:
#    creates: "/etc/restic/repositories/{{ item.repository|quote }}.initialized"
#    cmd: >
#      restic stats --json -r {{ restic_backup_url|quote }}{{ item.repository|quote }} --password-file "/etc/restic/repositories/{{ item.repository|quote }}.key"
#          > /etc/ansible/facts.d/restic-repos-{{ item.repository | quote }}.fact   &&
#      touch '/etc/restic/repositories/{{ item.repository|quote }}.initialized'
#  failed_when: false
#  loop: "{{ restic_backup_directives }}"
#  register: repository_x_stats

- name: Re-read facts after adding custom fact
  ansible.builtin.setup:
    filter: ansible_local

- name: Create repository where necessary
  ansible.builtin.shell:
    creates: "/etc/restic/repositories/{{ item.repository|quote }}.initialized"
    cmd: >
      restic init --json -r {{ restic_backup_url |quote}}{{ item.repository|quote }} --password-file "/etc/restic/repositories/{{ item.repository|quote }}.key" &&
      touch '/etc/restic/repositories/{{ item.repository|quote }}.initialized'
  loop: "{{ restic_backup_directives }}"

- name: deploy service unit for restic client
  template:
    src: 'restic-backup-oneshot@.service'
    dest: '/etc/systemd/system/'
    mode: 0644

- name: deploy specialized service unit for database backups
  template:
    src: 'restic-backup-oneshot@database.service.j2'
    dest: '/etc/systemd/system/restic-backup-oneshot@{{ item.name|quote }}.service'
    mode: 0644
  loop: "{{ restic_backup_directives }}"
  when: item.database_dump_command is defined

- name: remove specialized service unit where unnecessary
  ansible.builtin.file:
    path: '/etc/systemd/system/restic-backup-oneshot@{{ item.name|quote }}.service'
    state: absent
  loop: "{{ restic_backup_directives }}"
  when: item.database_dump_command is undefined

- name: deploy timer units for restic client
  template:
    src: 'restic-backup-daily@.timer'
    dest: '/etc/systemd/system/'
    mode: 0644

    #notify: systemd reload

- name: Have Systemd read configs
  ansible.builtin.systemd:
    daemon_reload: yes


