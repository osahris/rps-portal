---
- name: display current host
  debug:
    msg:
      - "{{ ansible_ssh_host }}"
      - "{{ inventory_hostname }}"

- name: create directory
  file: path={{remote_path}} state=directory
  
- name: Clone style_server repo
  git:
    repo: "{{ rps_style_servers_git_url }}"
    version: "{{ rps_style_servers_git_branch }}"
    dest: "{{remote_path}}/"
    force: yes

- name: copy some templated .j2 files
  template:
    src: "{{item}}" # relative to ./templates on local role path
    dest: "{{remote_path}}/{{ item | regex_replace(role_path+'/templates/', '') | regex_replace('\\.j2', '') }}" # relative to ~/ on remote
  with_items:
    - "docker-compose.yml.j2"
    
- name: copy traefik dynamic config
  copy:
    content: "{{ traefik_dynamic_config | to_nice_yaml(indent=2, width=777) }}"
    dest: "/srv/traefik/conf.d/rps-style.yaml"

- name: style_server container
  docker_compose:
    project_src: "{{remote_path}}/"
    files: "{{item}}"
    build: true
    pull: true
    remove_orphans: true
  with_items:
    - "docker-compose.yml"

# - name: build style image
#   community.docker.docker_image:
#     name: style
#     source: build
#     build:
#       path: "{{remote_path}}/"
#       # rm: false
#     tag: dev
#     force_tag: true
#     force_source: true

# - name: style_server container
#   community.general.docker_container:
#     name: style_server
#     image: style_server:dev
#     restart_policy: always
#     container_default_behavior: no_defaults
#     networks_cli_compatible: false
#     state: started
#     ports:
#      - "80:80"