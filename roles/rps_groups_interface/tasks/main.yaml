---

- import_tasks: secrets.yaml

- name: create application directory
  file:
    path: "{{remote_path}}"
    state: directory

- include_tasks: oauth2_proxy_setup.yaml
  loop: "{{ rps_groups_interface_managed_realms }}"
  loop_control:
    loop_var: realm

# does not use a template like normally because it is super dynamic. see vars/
- name: create docker compose yaml
  copy:
    content: "{{ rps_groups_interface_docker_compose|to_nice_yaml(indent=2) }}"
    dest: "{{remote_path}}/docker-compose.yaml"

- name: create docker compose env-oauth2-proxy file
  template:
    src: "env-oauth2-proxy.j2"
    dest: "{{remote_path}}/env-oauth2-proxy"

- name: deploy docker-compose stack
  docker_compose:
    project_src: "{{remote_path}}/"
    files: "docker-compose.yaml"
    pull: true
    remove_orphans: true

- name: delete obsolete traefik dynamic config
  file:
    path: "/app/proxy/traefik/conf.d/rps-groups-interface.yaml"
    state: absent

# TODO: fix traefik config
# - name: traefik dynamic config
#   copy:
#     content: "{{ rps_groups_interface_traefik_dynamic_config }}"
#     dest: "/app/proxy/traefik/conf.d/rps-groups-interface.yaml"
