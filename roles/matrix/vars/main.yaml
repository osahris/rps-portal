---
remote_path: "/srv/{{chat_service_name}}"

chat_secrets:
  chat_sevret_var_name:               "{{ chat_sevret_var_name | default(lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits')) }}"
  chat_postgress_password:         "{{ chat_postgress_password | default(lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits')) }}"
  chat_keycloak_client_secret: "{{ chat_keycloak_client_secret | default(lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits')) }}"

traefik_certresolver: "letsencrypt"
app_port: "8008"

# For each new running service add below a traefik router and a traefik service
traefik_dynamic_config:
  http:
    routers:

      nginx:
        rule: "Host(`{{chat_service_name}}`)"
        entrypoints: websecure
        # middlewares: 
        # - header-redirect
        tls:
          certresolver: "{{traefik_certresolver}}"
        service: "nginx"

      synapse:
        rule: "Host(`matrix.{{chat_service_name}}`)"
        entrypoints: websecure
        # middlewares: 
        # - header-redirect
        tls:
          certresolver: "{{traefik_certresolver}}"
        service: "synapse"

      element:
        rule: "Host(`element.{{chat_service_name}}`)"
        entrypoints: websecure
        # middlewares: 
        # - header-redirect
        tls:
          certresolver: "{{traefik_certresolver}}"
        service: "element"

    services:

      nginx:
        loadBalancer:
          servers:
            - url: "http://{{chat_service_name|replace('.','')}}_nginx_1:8080" # "http://container_name:container_port"

      synapse:
        loadBalancer:
          servers:
            - url: "http://{{chat_service_name|replace('.','')}}_synapse_1:{{app_port}}" # "http://container_name:container_port"

      element:
        loadBalancer:
          servers:
            - url: "http://{{chat_service_name|replace('.','')}}_element_1:80" # "http://container_name:container_port"