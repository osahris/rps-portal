---

- include_role:
    name: certificate
  vars:
    certificate_name: "{{hostvars[vhost].reverse_proxy_server_name}}"
    certificate_common_name: "{{hostvars[vhost].reverse_proxy_server_name}}"
    certificate_alt_names: "{{ hostvars[vhost].reverse_proxy_server_names | default([hostvars[vhost].reverse_proxy_server_name]) | map('regex_replace', '^(.*)$','DNS:\\1') | list }}"
  loop: "{{reverse_proxy_for_hosts}}"
  loop_control:
    loop_var: vhost
  when: hostvars[vhost].reverse_proxy_server_name is defined

- include_role:
    name: openresty
    tasks_from: vhost
  vars:
    nginx_vhost_name: "{{vhost}}"
    nginx_vhost_server_names: "{{hostvars[vhost].reverse_proxy_server_names | default([hostvars[vhost].reverse_proxy_server_name]) }}"
    nginx_vhost_certificate_name: "{{hostvars[vhost].reverse_proxy_server_name}}"
    nginx_vhost_custom: "{{hostvars[vhost].reverse_proxy_nginx_vhost_custom|default('')}}"
    nginx_basic_auth_users: "{{hostvars[vhost].reverse_proxy_nginx_basic_auth_users | default([]) }}"
    nginx_vhost_locations: "{{hostvars[vhost].reverse_proxy_nginx_vhost_locations|default([])}}"
    nginx_security_headers: false
    openidc_auth: "{{ hostvars[vhost].reverse_proxy_openidc_auth | default(false) }}"
    logout_redirect_url: "{{ hostvars[vhost].reverse_proxy_openidc_auth_logout_redirect_url | default('') }}"
  loop: "{{reverse_proxy_for_hosts}}"
  loop_control:
    loop_var: vhost
  when: hostvars[vhost].reverse_proxy_server_name is defined
