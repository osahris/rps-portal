---
version: "3"

networks:
  proxy:
    external: true
  nextcloud-internal:

volumes:
  postgres:
  nextcloud-data:
  #nextcloud:

services:

  nextcloud:
    image: nextcloud:{{ nextcloud_version }}
    restart: unless-stopped
    logging:
      options:
        max-size: 5m
    restart: unless-stopped
    # ports:
    #   - 8080:80
    networks:
      - proxy
      - nextcloud-internal
    depends_on:
      - postgres
    volumes:
      # try to make the nextcloud installation "stateless"
      #- nextcloud:/var/www/html
      - nextcloud-data:{{ nextcloud_container_datadir }}
      - ./skel:{{ nextcloud_container_skeldir }}:ro
{% if nextcloud_import %}
      - ./migration-data/nextcloud-data:/srv/nextcloud-data-import:ro
{% endif %}
    env_file:
      - "./env"

  postgres:
    image: postgres:15.1
    restart: unless-stopped
    logging:
      options:
        max-size: 5m
    networks:
      - nextcloud-internal
    volumes:
      - postgres:/var/lib/postgresql/data
      - ./create-nextcloud-role.sh:/docker-entrypoint-initdb.d/create-nextcloud-role.sh
{% if nextcloud_import %}
      - ./migration-data/nextclouddb.sql:/docker-entrypoint-initdb.d/nextclouddb.sql
{% endif %}
    environment:
      - POSTGRES_PASSWORD=example
      - POSTGRES_DB=nextcloud
      - POSTGRES_NEXTCLOUD_USER=nextcloud
      - POSTGRES_NEXTCLOUD_PASSWORD={{ nextcloud_postgres_password }}

