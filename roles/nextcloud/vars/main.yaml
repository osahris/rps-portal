---
# Ansible variables
project_name: "nextcloud" #{{role_name}}"
remote_path: "/app/{{inventory_hostname}}/{{project_name}}"
project_domain_name: "{{inventory_hostname}}"


# # ------------------------------------------ #
# # Reverse proxy and SSL certification config #
# # ------------------------------------------ #
traefik_directory:          "/app/{{inventory_hostname}}/traefik"
traefik_dashboard_hostname: "traefik.{{project_domain_name}}"
traefik_certresolver:       "letsencrypt"
letsencrypt_account_email:  "{{ admin_email }}"
app_port: "80"

# # ------------------------------------------ #
_nextcloud_status:   "{{_nextcloud_status_task.stdout | from_json}}"
# # ------------------------------------------ #
MYSQL_HOST:          "{{project_name}}_db"
MYSQL_DATABASE:      "nextcloud"
MYSQL_USER:          "admin"
MYSQL_PASSWORD:      "Lfgj[eqnfr-nj]"
MYSQL_ROOT_PASSWORD: "Lfgj[eqnfr-nj]"
# # ------------------------------------------ #
keycloak_domain:     "keycloak.{{inventory_hostname}}"
keycloak_realm:      "rps"
keycloak_my_application_id:      "nextcloud"
keycloak_my_super_secret_secret: "dsaNzueQeiT4OCKJeh1Hca5MqeBrGHTG"

# For each new running service add below a traefik router and a traefik service
traefik_dynamic_config:
  http:
    routers:

      nextcloud:
          # rule: "Host(`{{project_domain_name}}`) && ( PathPrefix(`/api/`) || Path(`/api`) ) )"
          rule: "Host(`nextcloud.{{project_domain_name}}`)"
          # rule: "Host(`{{project_domain_name}}`)"
          entrypoints: websecure
          # middlewares:
          #   - oauth2-proxy-auth-redirect
          tls:
            certresolver: "{{traefik_certresolver}}"
            domains:
            - main: "nextcloud.{{project_domain_name}}"
            # - main: "{{project_domain_name}}"
              sans:
                - "{{traefik_dashboard_hostname}}"
          service: nextcloud

    services:
      nextcloud:
        loadBalancer:
          servers:
            - url: "http://{{project_name}}_app:{{app_port}}" # "http://container_name:container_port"



    # middlewares:
    #   oauth2-proxy-auth-redirect:
    #     forwardAuth:
    #       address: http://oauth2-proxy:4180/
    #       trustForwardHeader: true
    #       authResponseHeaders:
    #         - X-Auth-Request-Access-Token
    #         - Authorization
    #         - X-Auth-Request-Groups