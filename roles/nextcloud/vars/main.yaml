---
# Ansible variables
remote_path: "/app/{{nextcloud_service_name}}"
app_port: "80"

# # ------------------------------------------ #
_nextcloud_status: "{{_nextcloud_status_task.stdout | from_json}}"
_nextcloud_config: "{{ _nextcloud_config_cmd.stdout | from_json }}"

# # ------------------------------------------ #
MYSQL_HOST: "{{nextcloud_service_name|replace('.','')}}_db_1"
MYSQL_DATABASE: "nextcloud"
MYSQL_USER: "admin"
MYSQL_PASSWORD: "Lfgj[eqnfr-nj]"
MYSQL_ROOT_PASSWORD: "Lfgj[eqnfr-nj]"

# For each new running service add below a traefik router and a traefik service
traefik_dynamic_config:
  http:
    routers:
      nextcloud:
        rule: "Host(`{{ nextcloud_service_name }}`)"
        entrypoints: websecure
        tls:
          certresolver: letsencrypt
        service: nextcloud

    services:
      nextcloud:
        loadBalancer:
          servers:
            - url: "http://{{nextcloud_service_name|replace('.', '')}}_nextcloud_1:{{app_port}}" # "http://container_name:container_port"

    # middlewares:
    #   oauth2-proxy-auth-redirect:
    #     forwardAuth:
    #       address: http://oauth2-proxy:4180/
    #       trustForwardHeader: true
    #       authResponseHeaders:
    #         - X-Auth-Request-Access-Token
    #         - Authorization
    #         - X-Auth-Request-Groups

nextcloud_app_container_name: "{{nextcloud_service_name|replace('.', '')}}_nextcloud_1"

_nextcloud_apps_enabled: "{{ _nextcloud_occ_app_list.stdout | from_yaml | json_query('Enabled|[]|map(&keys(@), @)|[]') }}"
_nextcloud_apps_disabled: "{{ _nextcloud_occ_app_list.stdout | from_yaml | json_query('Disabled|[]') }}"
_nextcloud_apps_present: "{{ _nextcloud_apps_enabled | union(_nextcloud_apps_disabled) }}"

nextcloud_default_config:
  system:
    defaultapp: "{{nextcloud_defaultapp}}"
    skeletondirectory: /srv/nextcloud/skel
    trusted_domains:
      - "{{ nextcloud_service_name }}"

nextcloud_user_oidc_config:
  apps:
    user_oidc:
      allow_multiple_user_backends: "{{nextcloud_user_oidc_allow_multiple_user_backends|bool|lower}}"
      userinfo_bearer_validation: "{{nextcloud_user_oidc_userinfo_bearer_validation|bool|lower}}"

nextcloud_oidc_login_config: # legacy plugin
  system:
    oidc_login_client_id: "{{ nextcloud_oidc_login_client_id }}"
    oidc_login_client_secret: "{{ nextcloud_oidc_login_client_secret }}"
    oidc_login_provider_url: "{{ nextcloud_oidc_login_provider_url }}"
    # oidc_login_logout_url: "{{ nextcloud_oidc_login_logout_url }}"
    oidc_login_auto_redirect: "{{ nextcloud_oidc_login_auto_redirect|bool }}"
    oidc_login_redir_fallback: "{{ nextcloud_oidc_login_redir_fallback|bool }}"
    oidc_login_attributes: "{{ nextcloud_oidc_login_attributes }}"
    oidc_login_tls_verify: "{{ nextcloud_oidc_login_tls_verify|bool }}"
    oidc_login_disable_registration: "{{ nextcloud_oidc_login_disable_registration|bool }}"

nextcloud_custom_theme_config:
  system:
    theme: "{{nextcloud_custom_theme_name}}"
