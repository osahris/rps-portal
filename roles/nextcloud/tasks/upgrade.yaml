---

- name: Shutdown docker-compose stack
  docker_compose:
    project_src: "{{remote_path}}/"
    pull: true
    remove_orphans: true
    state: absent

- name: Bring Nextcloud database up
  docker_compose:
    project_src: "{{remote_path}}/"
    pull: true
    remove_orphans: true
    services:
      - postgres

- name: Display the Nextcloud upgrade path
  debug:
    var: nextcloud_upgrade_path_via_versions

- include_tasks: upgrade_loop.yaml
  vars:
    nextcloud_version: "{{ item }}"
  loop: "{{ nextcloud_upgrade_path_via_versions }}"

- name: Deploy the docker stack with the current version of nextcloud {{ nextcloud_current_version }}}
  docker_compose:
    project_src: "{{remote_path}}/"
    pull: true
    remove_orphans: true

- name: Wait for docker-compose stack deployment after upgrade
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ status --output=json
  register: _nextcloud_status_task
  changed_when: false
  retries: 180
  delay: 1
  until: _nextcloud_status_task is not failed
  when: nextcloud_wait_for_stack_on_deploy
