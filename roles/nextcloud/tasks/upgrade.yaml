---
- name: Upgrade -- Get current Nexcloud version
  community.docker.docker_container_exec:
    container: "{{nextcloud_service_name|replace('.', '')}}_nextcloud_1"
    command: php occ status --output=json
    user: www-data
  register: nextcloud_current_version_dict

- set_fact:
    nextcloud_current_version="{{ (nextcloud_current_version_dict.stdout | from_json )['versionstring'] }}"

- name: Upgrade -- Display the Nextcloud current version
  debug:
    var: nextcloud_current_version

- name: Upgrade -- Display the Nextcloud upgrade path
  debug:
    var: nextcloud_upgrade_path_via_versions

- name: Upgrade -- Shutdown docker-compose stack
  docker_compose:
    project_src: "{{remote_path}}/"
    pull: true
    remove_orphans: true
    state: absent

- name: Upgrade -- launch upgrade_loop.yaml
  include_tasks: upgrade_loop.yaml
  vars:
    nextcloud_version: "{{ item }}"
  loop: "{{ nextcloud_upgrade_path_via_versions }}"

# - name: Upgrade -- Deploy the docker stack with the current version of nextcloud {{ nextcloud_current_version }}}
#   docker_compose:
#     project_src: "{{remote_path}}/"
#     pull: true
#     remove_orphans: true

# - name: Upgrade -- Wait for docker-compose stack deployment after upgrade
#   community.docker.docker_container_exec:
#     container: "{{nextcloud_app_container_name}}"
#     user: www-data
#     command: php occ status --output=json
#   register: _nextcloud_status_task
#   changed_when: false
#   retries: 180
#   delay: 1
#   until: _nextcloud_status_task is not failed
