---

- name: install required debian packages
  apt:
    pkg:
    - git

- name: copy nextcloud docker-compose file
  copy:
    content: "{{ nextcloud_docker_compose }}"
    dest: "{{ nextcloud_project_directory }}/docker-compose.yml"

- name: deploy nextcloud docker-compose
  community.docker.docker_compose:
    project_name: "{{ nextcloud_project_name }}"
    project_src: "{{ nextcloud_project_directory }}"
  register: _nextcloud_docker_compose

- name: check nextcloud status
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ status --output=json
  register: _nextcloud_status_task
  changed_when: false
  retries: 60
  delay: 1
  until: _nextcloud_status_task is not failed

- name: install nextcloud
  when: not _nextcloud_status.installed
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command:
      php occ maintenance:install
      --admin-user "{{ nextcloud_admin_user }}"
      --admin-pass "{{ nextcloud_admin_pass }}"
