---

- name: copy env
  template:
    src: "env.j2"
    dest: "{{remote_path}}/env"

- name: copy config.yaml
  template:
    src: "config.yaml.j2"
    dest: "{{remote_path}}/config.yaml"

- name: copy docker-compose.yaml
  template:
    src: "docker-compose.yaml.j2"
    dest: "{{remote_path}}/docker-compose.yaml"

- name: create postgresql script directory
  ansible.builtin.file:
    path: "{{ remote_path }}/initdb"
    state: directory
    # TODO: figure out minimal permission set here
    mode: 0755

- name: deploy script to create a backup user in database
  template:
    src: "create-default-postgres-user.sh.j2"
    dest: "{{remote_path}}/initdb/create-default-postgres-user.sh"
    mode: "ugo=rx"

# Import the data from given SQL dump to the freshly deployed postgres
- import_tasks: import.yaml
  when: nextcloud_import

- name: deploy docker-compose stack
  docker_compose:
    profiles: "{{ nextcloud_docker_compose_profile }}"
    project_src: "{{remote_path}}/"
    pull: true
    remove_orphans: true

- name: wait for docker-compose stack deployment
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ status --output=json
  register: _nextcloud_status_task
  changed_when: false
  retries: 180
  delay: 1
  until: _nextcloud_status_task is not failed

- import_tasks: upgrade.yaml
  when: nextcloud_upgrade

- import_tasks: initialize.yaml
  when: nextcloud_initialize

- name: query nextcloud status again to assert if it is initialized
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ status --output=json
  register: _nextcloud_status_task
  changed_when: false

- name: assert that nextcloud is initialized
  assert:
    that: _nextcloud_status.installed
    msg: |
      Nextcloud is not initialized!
      Ansible somehow skipped the initialize step of the nextcloud role.
      There might be something wrong with the docker-compose stack deployment. Please check the logs.

- name: Update htaccess
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ maintenance:update:htaccess
