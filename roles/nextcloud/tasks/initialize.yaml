---

- name: 'Prepare the "nextcloud-data/" directory within the container'
  community.docker.docker_container_exec:
    container: "{{ nextcloud_app_container_name }}"
    command: >
        chown -R www-data: -R "{{nextcloud_container_datadir}}"

- name: 'Prepare the "nextcloud-data/" directory within the container (II)'
  community.docker.docker_container_exec:
    container: "{{ nextcloud_app_container_name }}"
    command: >
        touch "{{nextcloud_container_datadir}}/.ocdata"

- name: query nextcloud status
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ status --output=json
  register: _nextcloud_status_task
  changed_when: false

- name: initialize nextcloud
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ maintenance:install --data-dir="{{nextcloud_container_datadir}}" --admin-user="{{nextcloud_admin_user}}" --admin-pass="{{nextcloud_admin_password}}" --database="pgsql" --database-name="{{nextcloud_postgres_database}}" --database-host="{{nextcloud_db_hostname}}" --database-user="{{nextcloud_postgres_user}}" --database-pass="{{nextcloud_postgres_password}}"
  when: not _nextcloud_status.installed

- name: query nextcloud status again
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ status --output=json
  register: _nextcloud_status_task
  changed_when: false

- name: assert that nextcloud is initialized
  assert:
    that: _nextcloud_status.installed
    msg: |
      Nextcloud is not initialized!
      Ansible somehow skipped the initialize step of the nextcloud role.
      There might be something wrong with the docker-compose stack deployment. Please check the logs.
