---

- name: copy docker-compose.yaml without header injection
  template:
    src: "docker-compose.yaml.j2"
    dest: "{{remote_path}}/docker-compose.yaml"
  vars:
    nextcloud_with_header_injection: false

- name: deploy docker-compose stack without header injection
  docker_compose:
    project_src: "{{remote_path}}/"
    pull: true
    remove_orphans: true

- name: wait for docker-compose stack deployment before installation
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ status --output=json
  register: _nextcloud_status_task
  changed_when: false
  retries: 180
  delay: 1
  until: _nextcloud_status_task is not failed

- name: install nextcloud
  community.docker.docker_container_exec:
    container: "{{nextcloud_app_container_name}}"
    user: www-data
    command: php occ maintenance:install --admin-user="{{nextcloud_admin_user}}" --admin-pass="{{nextcloud_admin_password}}" --database="mysql" --database-name="{{nextcloud_mysql_database}}" --database-host="{{nextcloud_db_container_name}}" --database-user="{{nextcloud_mysql_user}}" --database-pass="{{nextcloud_mysql_password}}"
  # https://docs.nextcloud.com/server/latest/admin_manual/configuration_server/occ_command.html
