---

- name: app folder for service
  file:
    path: /srv/{{gitea_service_name}}
    state: directory

- name: db env file
  template:
    src: db.env.j2
    dest: /srv/{{gitea_service_name}}/db.env

- name: gitea env file
  template:
    src: gitea.env.j2
    dest: /srv/{{gitea_service_name}}/gitea.env

- name: copy docker-compose file
  copy:
    src: docker-compose.yaml
    dest: /srv/{{gitea_service_name}}/docker-compose.yaml

# - name: template docker-compose override file
#   template:
#     src: docker-compose.override.yaml.j2
#     dest: /srv/{{gitea_service_name}}/docker-compose.override.yaml

- name: template oauth2-proxy env file
  template:
    src: oauth2-proxy.env.j2
    dest: /srv/{{ gitea_service_name }}/oauth2-proxy.env

- name: template oauth2-proxy-redis env file
  template:
    src: oauth2-proxy-redis.env.j2
    dest: /srv/{{ gitea_service_name }}/oauth2-proxy-redis.env

- name: traefik config directory
  file:
    path: /srv/{{ gitea_service_name }}/traefik
    state: directory

- name: template local traefik dynamic config
  template:
    src: traefik.yaml.j2
    dest: /srv/{{ gitea_service_name }}/traefik/gitea.yaml

- name: deploy docker-compose stack
  docker_compose:
    project_src: /srv/{{ gitea_service_name }}
  register: gitea_docker_compose_task

- name: wait for gitea http port to be open
  wait_for:
      port: "{{ gitea_http_port }}"
      host: "{{ gitea_docker_compose_task.services.gitea[gitea_service_name|replace('.', '')+'_gitea_1'].networks[gitea_service_name|replace('.', '')+'_service'].IPAddress }}"
