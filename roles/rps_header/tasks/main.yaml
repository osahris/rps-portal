---
- name: create application directory
  file:
    path: "{{remote_path}}"
    state: directory

- name: install git
  apt:
    name: git
    state: present

- name: clone header git repository
  git:
    repo: "{{ header_git_repo }}"
    dest: "{{ remote_path }}/header"
    force: true
    version: "sign-out-oauth2"

- name: create config.yaml
  copy:
    content: "{{ header_config }}"
    dest: "{{ remote_path }}/header/config.yaml"

- name: create docker compose yaml
  template:
    src: "docker-compose.yaml.j2"
    dest: "{{remote_path}}/docker-compose.yaml"

- name: deploy docker-compose stack
  docker_compose:
    project_src: "{{remote_path}}/"
    files: "docker-compose.yaml"
    pull: true
    build: true

- name: traefik dynamic config
  copy:
    content: "{{ header_traefik_dynamic_config }}"
    dest: "/app/proxy/traefik/conf.d/header.yaml"
