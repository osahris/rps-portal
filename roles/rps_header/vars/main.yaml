---
remote_path: "/app/{{header_service_name}}"

header_traefik_dynamic_config:
  http:
    routers:
      header:
        rule: "Host(`{{header_service_name}}`)"
        entrypoints: websecure
        middlewares:
        - header-redirect
        tls:
          certresolver: letsencrypt
        service: header

    services:
      header:
        loadBalancer:
          servers:
            - url: "http://{{header_service_name|replace('.', '')}}_header_1:4080"

    # This 'header-redirect' middleware redirects every subdomain SERVICENAME.domain/header.js to header.domain/header.js
    # If this SERVICENAME has this middleware included like this --|
    #                                                              |
    # traefik_dynamic_config:                                      |
    #   http:                                                      |
    #     routers:                                                 |
    #       SERVICENAME:                                           |
    #         rule: "Host(`SERVICENAME.domain`)"                   |
    #         entrypoints: websecure                               |
    #         middlewares:                                         |
    #         - header-redirect # <<< ------ here ------ <<< ------|
    #         tls:
    #           certresolver: letsencrypt
    #         service: SERVICENAME
    middlewares:
      header-redirect:
        redirectRegex:
          regex: "^http?s://.*{{inventory_hostname}}/header.js"
          replacement: "https://{{header_service_name}}/header.js"
          permanent: true
