---
- name: create application directory
  file:
    path: "{{remote_path}}"
    state: directory

- name: create application files for {{ env }}
  template:
    src: "{{item}}"
    dest: "{{remote_path}}/{{item | regex_replace('\\.j2$', '') }}"
  with_items:
    - "docker-compose.yaml.j2"
    - "env-mysql.j2"
    - "env-wordpress.j2"
    - "wp-extra-config.php.j2"

- name: deploy wp-cli helper
  copy:
    src: wp-cli-helper.sh
    dest: "{{remote_path}}/wp-cli"
    mode: 0755

- block:
    - name: deploy env live helper
      template:
        src: env-live.j2
        dest: "{{remote_path}}/env-live"
        mode: 0644

    - name: deploy update script
      copy:
        src: files/deploy-draft-to-live.sh
        dest: "{{remote_path}}/deploy-draft-to-live.sh"
        mode: 0755
  when: env == "draft"

- name: deploy docker-compose stack
  docker_compose:
    project_src: "{{remote_path}}"
    files: "docker-compose.yaml"
    pull: true
    remove_orphans: true

# ansible doesn't support waiting for docker-compose setup
- block:
    - name: get infos from wordpress container
      community.docker.docker_container_info:
        name: "{{ lookup('ansible.builtin.vars', 'wordpress_' + env + '_service_name')|replace('.', '') }}_wordpress_1"
      register: result
    - name: wait for wordpress is running (either installation mode or normal)
      ansible.builtin.wait_for:
        port: 80
        host: "{{ result.container.NetworkSettings.Networks.proxy.IPAddress }}"

- name: check wordpress installation status
  command: ./wp-cli core is-installed
  args:
    chdir: "{{remote_path}}"
  changed_when: false
  failed_when: false
  register: wordpress_installation_status

- name: install wordpress
  command: ./wp-cli core install --admin_user=admin --admin_email={{ rps_admin_email }} --url=https://{{ lookup('ansible.builtin.vars', 'wordpress_' + env + '_service_name') }} --title=rps --skip-email --admin_password={{ lookup('ansible.builtin.vars', 'wordpress_' + env + '_admin_password') }}
  args:
    chdir: "{{remote_path}}"
  when: wordpress_installation_status.rc != 0

- name: forbid traffic to wp-admin
  ansible.builtin.lineinfile:
    path: "/var/lib/docker/volumes/{{ lookup('ansible.builtin.vars', 'wordpress_' + env + '_service_name')|replace('.', '') }}_wordpress/_data/.htaccess"
    search_string: 'RewriteRule "^wp-admin/" "-" [F]'
    insertafter: "RewriteBase /"
    line: 'RewriteRule "^wp-admin/" "-" [F]'
  when: env == "live"

- name: install traefik dynamic config
  copy:
    content: "{{ lookup('ansible.builtin.vars', 'wordpress_' + env + '_traefik_dynamic_config') }}"
    dest: "/app/proxy/traefik/conf.d/wordpress-{{ env }}.yaml"
