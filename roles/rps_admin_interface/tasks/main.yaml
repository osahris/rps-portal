---
- import_tasks: secrets.yaml

- name: install git
  apt:
    name: git
    state: present

- name: clone rps-admin-tools git repository
  git:
    repo: "{{ rps_admin_web_interface_git_repo }}"
    version: "{{ rps_admin_web_interface_git_version }}"
    dest: "{{ remote_path }}/rps-admin-tools"
    force: true

- name: copy rps admin web interface docker-compose.yaml
  template:
    src: docker-compose.yaml.j2
    dest: "{{ remote_path }}/docker-compose.yaml"

- name: traefik dynamic config
  copy:
    content: "{{ rps_admin_interface_traefik_dynamic_config }}"
    dest: "/app/proxy/traefik/conf.d/rps-admin-interface.yaml"

- name: rps admin web interface config
  copy:
    content: "{{rps_tools_config|to_json}}"
    dest: "{{ remote_path }}/rps-admin-tools.json"

- name: rps admin web interface local settings
  template:
    src: settings_local.py.j2
    dest: "{{ remote_path }}/settings_local.py"

- name: deploy docker-compose stack
  docker_compose:
    project_src: "{{remote_path}}/"
    files: "docker-compose.yaml"
    pull: true
    build: true
    remove_orphans: true
