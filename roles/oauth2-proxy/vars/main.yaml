---
project_name: "oauth2-proxy"
remote_path: "/app/{{inventory_hostname}}/{{project_name}}"
oauth2_proxy_traefik_dynamic_config:
  http:
    routers:
      oauth2-proxy:
        rule: "Host(`groups.{{ inventory_hostname }}`, `{{ oauth2_proxy_server_name }}`) && PathPrefix(`/oauth2/`)"
        entrypoints: websecure
        service: oauth2-proxy
        tls:
          certresolver: "{{traefik_certresolver}}"
    services:
      oauth2-proxy:
        loadBalancer:
          servers:
            - url: "http://oauth2-proxy:4180"
    middlewares:
      oauth2-auth:
        forwardAuth:
          address: "{{ oauth2_proxy_base_url }}/oauth2/auth"
          authResponseHeaders:
            - X-Auth-Request-Access-Token
            - X-Auth-Request-User
            - X-Auth-Request-Email
            - X-Auth-Request-Preferred-Username
            - X-Auth-Request-Groups
          # unclear if this is really needed and what it does but it is present everywhere in the docs
          trustForwardHeader: true
      oauth2-errors:
        errors:
          status:
            - "401"
          service: oauth2-proxy
          query: "{{ oauth2_proxy_needs_login_redirect }}"
