- hosts: hosts
  remote_user: root

- hosts: reverse-proxy
  remote_user: root
  vars:
    lxd_container_address: "{{lxd_container_json.stdout | from_json | json_query('[0].state.network.eth0.addresses[0].address') }}"
    lxd_host_address: "{{ lxd_host_ip | default(hostvars[lxd_host].host_public_ip) }}"
  tasks:
    - name: list ipv4 address for proxy
      command: lxc ls reverse-proxy --format=json
      register: lxd_container_json
      delegate_to: "{{ lxd_host }}"
      changed_when: false

    # todo: make this permanent (using ufw?)
    # todo: make interfaces configurable or auto-detect
    - name: add ipv4 forwarding for proxy
      command: "{{ item }}"
      loop:
        - "iptables -t nat -A PREROUTING -d {{ lxd_host_address }} -p tcp --dport 80 -j DNAT --to {{ lxd_container_address }}:80"
        - "iptables -t nat -A PREROUTING -d {{ lxd_host_address }} -p tcp --dport 443 -j DNAT --to {{ lxd_container_address }}:443"
        - "iptables -I FORWARD -p tcp -d {{ lxd_container_address }} --dport 80 -j ACCEPT"
        - "iptables -I FORWARD -p tcp -d {{ lxd_container_address }} --dport 443 -j ACCEPT"
      delegate_to: "{{ lxd_host }}"
